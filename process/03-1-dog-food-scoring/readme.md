# プロセス 03-1-dog-food-scoring: 犬のレシピ素材適性スコアリング

## 概要

食品成分表の各食品に対して、犬のレシピ素材としての適性を10段階で評価するプロセスです。
AIを使用して評価を行い、後続のフィルタリング処理（03-2）で使用します。

## 入力

### 入力ファイル

- **パス**: `../02-food-name-normalize/result/claude-json-header-with-structured-names.csv`
- **形式**: CSV（UTF-8）
- **構造**:
  - 1行目: ヘッダー行
  - 2行目以降: データ行
  - **食品番号**: 2列目（インデックス1）
  - **食品名**: 4列目（インデックス3）
  - **構造化食品名**: 最後の列（JSON文字列形式）

### 入力データ例

```csv
01,01001,0001,アマランサス　玄穀,...,"{""baseName"":""アマランサス"",""variety"":""玄穀""}"
```

## 処理フロー

1. CSVを読み込み、全行をシャッフル（シード値固定で再現可能）
2. 10行ずつバッチでAI評価を実行
3. 結果を累積的にファイルに書き出し（途中再開可能）
4. 処理済みインデックスを記録して再開時にスキップ

## 出力

### 出力ファイル構造

#### 1. `result/scores.csv`

評価結果を格納するCSVファイル。累積的に追記される。

- **形式**: CSV（UTF-8）
- **ヘッダー行**: `食品番号,理由,スコア`
- **データ行**: 各食品の評価結果
- **列の説明**:
  - `食品番号`: 2桁の食品群番号 + 5桁の食品番号（例: `01001`）
  - `スコア`: 1-10の整数
  - `理由`: 評価理由のテキスト（カンマや改行が含まれる場合はダブルクォートでエスケープ）

**例**:
```csv
食品番号,理由,スコア
01001,穀物類で犬のレシピ素材として適している,8
01002,精白粒で加工度が低く使用可能,7
```

#### 2. `result/progress.json`

処理進捗を記録するJSONファイル。途中再開時に使用される。

- **形式**: JSON
- **構造**:
  ```json
  {
    "processedIndices": [0, 1, 2, 5, 10, ...],
    "shuffledIndices": [42, 123, 5, 89, ...]
  }
  ```
- **フィールドの説明**:
  - `processedIndices`: 処理済みのシャッフル後の位置（0始まりのインデックス）の配列（ソート済み）
  - `shuffledIndices`: シャッフル後の元データのインデックス配列（全データ分）

**注意**: 
- `shuffledIndices`は全データ分の長さを持つ配列
- `processedIndices`は処理済みの位置のみを含む（ソート済み）
- 再開時は`processedIndices`に含まれる位置をスキップする

---

## 評価基準（10段階スコア）

### スコアの定義

| スコア | 説明 |
|--------|------|
| 1-2 | **危険** - 犬に有害な成分を含む、絶対に与えてはいけない |
| 3-4 | **不適切** - 過剰な加工、高塩分、高糖分など犬の食事に適さない |
| 5-6 | **条件付き** - 加工度が高い、調理済み食品など、素材として使いにくい |
| 7-8 | **適切** - 犬のレシピ素材として使用可能 |
| 9-10 | **最適** - 犬のレシピ素材として理想的（生鮮食品、肉類、野菜など） |

### 評価軸

#### 1. 毒性・有害性（最重要）
犬に有害な成分を含む食品は自動的に低スコア（1-2）となる：

| 有害食品 | 有害成分 | 影響 |
|----------|----------|------|
| 玉ねぎ、ネギ類、ニラ、にんにく | アリルプロピルジスルフィド | 溶血性貧血（赤血球破壊） |
| ぶどう、レーズン | 不明（酒石酸が疑われる） | 急性腎不全 |
| チョコレート、ココア、コーヒー | テオブロミン、カフェイン | 神経系・心臓への悪影響、痙攣 |
| マカダミアナッツ | 不明 | 脱力、嘔吐、高体温 |
| キシリトール含有食品 | キシリトール | 低血糖、肝障害 |
| アルコール、酒類 | エタノール | 中枢神経抑制、呼吸困難 |
| 生のイースト生地 | 酵母 | 腸内でガス発生、膨張 |

#### 2. 加工度・調理済み状態
- 生鮮食品・素材 → 高スコア
- 調理済み食品（惣菜、弁当など） → 低スコア
- 加工食品（ハム、ソーセージ、練り物など） → 中〜低スコア

#### 3. 塩分・糖分
- 塩分が高い食品（漬物、塩蔵品、調味料など） → 低スコア
- 糖分が高い食品（菓子類、ジャム、清涼飲料水など） → 低スコア

#### 4. 素材としての実用性
- 単一素材・食材 → 高スコア
- 複合食品・料理 → 低スコア
- 調味料・香辛料 → 低スコア

---

## エビデンス

### 参考文献

1. **ASPCA Animal Poison Control Center**
   - URL: https://www.aspca.org/pet-care/aspca-poison-control/people-foods-avoid-feeding-your-pets
   - 犬に与えてはいけない食品の包括的リスト

2. **日本語情報源**
   - 玉ねぎ・ネギ類の有害性: https://woman.mynavi.jp/article/150223-8/
   - ぶどう・レーズンの危険性: https://www.breeder-navi.jp/column/knowledge/basic/knowledge-016/
   - チョコレート・カフェインの影響: https://www.wepet.jp/health/8620/

### ASPCA による有害食品リスト（要約）

- **アルコール・イースト生地**: 嘔吐、下痢、協調運動障害、中枢神経抑制、呼吸困難、昏睡、死亡の可能性
- **チョコレート・コーヒー・カフェイン**: メチルキサンチン含有、嘔吐、異常な心拍、痙攣、死亡の可能性
- **ぶどう・レーズン**: 腎臓障害、少量でも危険
- **玉ねぎ・にんにく・チャイブ**: 消化器刺激、赤血球損傷、貧血のリスク
- **マカダミアナッツ**: 脱力、嘔吐、高体温
- **キシリトール**: インスリン放出を促進、低血糖、肝障害
- **牛乳・乳製品**: ラクターゼ不足により消化不良
- **塩分の多いスナック**: ナトリウムイオン中毒、痙攣、死亡の可能性

---

## 技術仕様

- **使用モデル**: gpt-5-mini-2025-08-07（OpenAI via Vercel AI SDK）
- **バッチサイズ**: 10行
- **シャッフルシード**: 42（固定値、再現性確保）
- **出力形式**: CSV（食品番号, 理由, スコア）

## ファイル構造

```
process/03-1-dog-food-scoring/
├── index.ts                    # メイン処理スクリプト
├── readme.md                   # このファイル
└── result/                     # 出力ディレクトリ（自動生成）
    ├── scores.csv              # 評価結果（累積出力）
    └── progress.json           # 処理進捗（再開用）
```

## 後続プロセス（03-2）への連携

### 使用する出力ファイル

- **`result/scores.csv`**: 食品番号とスコアのマッピング
  - このファイルを読み込み、元のCSVデータと突き合わせてフィルタリングを行う
  - `食品番号`をキーとして結合する

### データ形式の注意点

- `scores.csv`の`食品番号`は元のCSVの2列目（食品番号）と一致する
- スコアが低い（1-4点）食品を除外する処理を想定
- `理由`列は参考情報として利用可能
