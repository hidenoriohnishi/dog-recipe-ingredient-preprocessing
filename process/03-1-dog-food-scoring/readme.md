# プロセス 03-1-dog-food-scoring: 犬のレシピ素材適性スコアリング

## 概要

食品成分表の各食品に対して、犬のレシピ素材としての適性を10段階で評価するプロセスです。
AIを使用して評価を行い、後続のフィルタリング処理（03-2）で使用します。

## 入力

### 入力ファイル

- **パス**: `../02-food-name-normalize/result/claude-json-header-with-structured-names.csv`
- **形式**: CSV（UTF-8）
- **構造**:
  - 1行目: ヘッダー行
  - 2行目以降: データ行
  - **食品番号**: 2列目（インデックス1）
  - **食品名**: 4列目（インデックス3）
  - **構造化食品名**: 最後の列（JSON文字列形式）

### 入力データ例

```csv
01,01001,0001,アマランサス　玄穀,...,"{""baseName"":""アマランサス"",""variety"":""玄穀""}"
```

## 処理フロー

1. CSVを読み込み、全行をシャッフル（シード値固定で再現可能）
2. 10行ずつバッチでAI評価を実行
3. 結果を累積的にファイルに書き出し（途中再開可能）
4. 処理済みインデックスを記録して再開時にスキップ

## 出力

### 出力ファイル構造

#### 1. `result/scores.csv`

評価結果を格納するCSVファイル。累積的に追記される。

- **形式**: CSV（UTF-8）
- **ヘッダー行**: `食品番号,理由,スコア`
- **データ行**: 各食品の評価結果
- **列の説明**:
  - `食品番号`: 2桁の食品群番号 + 5桁の食品番号（例: `01001`）
  - `スコア`: 1-10の整数
  - `理由`: 評価理由のテキスト（カンマや改行が含まれる場合はダブルクォートでエスケープ）

**例**:
```csv
食品番号,理由,スコア
01001,穀物類で犬のレシピ素材として適している,8
01002,精白粒で加工度が低く使用可能,7
```

#### 2. `result/progress.json`

処理進捗を記録するJSONファイル。途中再開時に使用される。

- **形式**: JSON
- **構造**:
  ```json
  {
    "processedIndices": [0, 1, 2, 5, 10, ...],
    "shuffledIndices": [42, 123, 5, 89, ...]
  }
  ```
- **フィールドの説明**:
  - `processedIndices`: 処理済みのシャッフル後の位置（0始まりのインデックス）の配列（ソート済み）
  - `shuffledIndices`: シャッフル後の元データのインデックス配列（全データ分）

**注意**: 
- `shuffledIndices`は全データ分の長さを持つ配列
- `processedIndices`は処理済みの位置のみを含む（ソート済み）
- 再開時は`processedIndices`に含まれる位置をスキップする

---

## 評価基準（10段階スコア）

### スコアの定義

| スコア | 説明 |
|--------|------|
| 1-2 | **危険** - 犬に有害な成分を含む、絶対に与えてはいけない |
| 3-4 | **不適切** - 過剰な加工、高塩分、高糖分など犬の食事に適さない |
| 5-6 | **条件付き** - 加工度が高い、調理済み食品など、素材として使いにくい |
| 7-8 | **適切** - 犬のレシピ素材として使用可能 |
| 9-10 | **最適** - 犬のレシピ素材として理想的（生鮮食品、肉類、野菜など） |

### 評価軸

#### 1. 毒性・有害性（最重要）
犬に有害な成分を含む食品は自動的に低スコア（1-2点）となる。

##### 絶対禁忌食品リスト（1-2点）

| カテゴリ | 有害食品 | 有害成分 | 影響 |
|----------|----------|----------|------|
| **ネギ属** | 玉ねぎ、ねぎ、長ねぎ、わけぎ、あさつき、にら、にんにく、らっきょう、エシャロット | アリルプロピルジスルフィド | 溶血性貧血（加熱しても毒性消えず） |
| **ぶどう類** | ぶどう、マスカット、巨峰、デラウェア、レーズン、ワイン | 酒石酸 | 急性腎不全（少量でも危険） |
| **プルーン・すもも** | プルーン（生・ドライ両方）、すもも、プラム | ソルビトール、高カリウム | 下痢、心臓への影響（果肉自体が危険） |
| **チョコレート・カフェイン** | チョコレート、ココア、カカオ、コーヒー、紅茶、緑茶、抹茶 | テオブロミン、カフェイン | 神経毒性、心臓毒性 |
| **マカダミアナッツ** | マカダミアナッツ | 不明 | 脱力、嘔吐、高体温 |
| **くるみ・ペカン** | くるみ、ペカン | ジュグロン | 神経毒性 |
| **アルコール** | 酒類全般、みりん、料理酒、ワイン、ビール、日本酒、ラム | エタノール | 中枢神経抑制、呼吸困難 |
| **キシリトール** | キシリトール含有食品、ガム | キシリトール | 低血糖、肝障害 |
| **ナツメグ** | ナツメグ | ミリスチシン | 神経毒性、震え、けいれん |
| **いちじく** | いちじく（生・ドライ） | フィシン、ソラレン | 消化器刺激、光線過敏症 |
| **スターフルーツ** | スターフルーツ | シュウ酸、カランボキシン | 腎臓障害（少量でも危険） |
| **生のイースト生地** | パン生地（発酵前） | 酵母 | 腸内でガス発生、膨張 |

##### 安全な核果類（果肉は安全、種・茎・葉は危険）

以下の果物の**果肉のみ**は犬に与えて問題なし（7-8点）：
- 桃、もも、ネクタリン、あんず、杏、さくらんぼ、チェリー、びわ、りんご、マンゴー、パパイヤ

※種・茎・葉にはアミグダリン（青酸配糖体）が含まれるため危険だが、食品成分表は通常果肉を指す

##### 注意が必要な食品（3-5点）

| カテゴリ | 食品 | スコア | 理由 |
|----------|------|--------|------|
| **香辛料** | 唐辛子、わさび、からし、山椒、胡椒、カレー粉 | 3-4点 | 消化器刺激 |
| **その他ナッツ** | アーモンド、ピスタチオ、カシューナッツ、ピーナッツ | 4-5点 | 消化不良、膵炎リスク |
| **アボカド** | アボカド | 4-5点 | ペルシン（毒性エビデンス不明確だが注意） |
| **ザクロ** | ザクロ | 2-3点 | 消化器障害 |
| **柑橘類** | レモン、グレープフルーツ | 3-4点 | ソラレン、リモネン |

##### 生食注意リスト（stateが「生」の場合の減点基準）

| カテゴリ | 食品 | スコア | 理由 |
|----------|------|--------|------|
| **生の豚肉・鶏肉** | 生の豚肉、生の鶏肉 | 5-6点 | サルモネラ、カンピロバクター、寄生虫 |
| **生の牛肉・馬肉** | 生の牛肉、生の馬肉、生のラム | 7-8点 | 比較的安全だが細菌リスクあり |
| **生卵** | 生卵、生卵白 | 5-6点 | アビジン（ビオチン欠乏症）、サルモネラ |
| **生の魚介類** | 生のイカ、タコ、エビ、カニ、貝類 | 5-6点 | チアミナーゼ（ビタミンB1欠乏症） |
| **生の川魚** | 生の川魚 | 4-5点 | 寄生虫リスク高い |
| **生の海水魚** | 刺身用の海水魚 | 6-7点 | 比較的安全 |
| **生の大豆** | 生の大豆 | 4-5点 | トリプシンインヒビター |
| **生のじゃがいも** | 生のじゃがいも | 3-4点 | ソラニン（神経毒性） |
| **未熟なトマト** | 未熟なトマト、生のナス | 4-5点 | ソラニン |

※「ゆで」「焼き」「蒸し」「煮」等の調理済み表記がある場合は減点しない

#### 2. 加工度・調理済み状態
- 調理済み食品（惣菜、弁当など） → 低スコア
- 加工食品（ハム、ソーセージ、練り物など） → 中〜低スコア

#### 3. 素材としての実用性
- 単一素材・食材 → 高スコア
- 複合食品・料理 → 低スコア

### 減点対象外

以下は減点対象としない（レシピプログラムが管理・調整するため）：

- 「糖分が高い」「塩分が高い」（少量使用・プログラムが調整）
- 「ビタミン過剰の恐れ」（プログラムが栄養計算）
- 「添加物が含まれる」（添加物自体は問題ない）
- 「骨がある」「殻がある」（調理時に除去される前提）
- 加熱済みの食品（「ゆで」「焼き」「蒸し」「煮」等の調理済み表記がある場合）

---

## エビデンス

### 参考文献

1. **ASPCA Animal Poison Control Center**
   - URL: https://www.aspca.org/pet-care/aspca-poison-control/people-foods-avoid-feeding-your-pets
   - 犬に与えてはいけない食品の包括的リスト

2. **PetMD**
   - Stone Fruits: https://www.petmd.com/dog/general-health/6-dangers-stone-fruits-dogs
   - Can Dogs Eat Nuts: https://www.petmd.com/dog/nutrition/can-dogs-eat-nuts

3. **日本語情報源**
   - 玉ねぎ・ネギ類の有害性: https://woman.mynavi.jp/article/150223-8/
   - ぶどう・レーズンの危険性: https://www.breeder-navi.jp/column/knowledge/basic/knowledge-016/
   - チョコレート・カフェインの影響: https://www.wepet.jp/health/8620/
   - 果物の危険性（プルーン含む）: https://inulove.jp/food-drinks/no-fruit/
   - プルーンの危険性: https://wanchan.jp/food/detail/53628
   - いちじくの危険性: https://wanchan.jp/food/detail/10501
   - 魚介類の危険性: https://wanchan.jp/column/detail/39822
   - 生肉・生卵の危険性: https://www.petfamilyins.co.jp/pns/article/pfs202203k/
   - 生食のリスク（Hills）: https://www.hills.co.jp/dog-care/nutrition-feeding/toxic-foods-for-dogs
   - 桃の安全性: https://magazine.cainz.com/wanqol/articles/right_meal_51
   - さくらんぼの安全性: https://magazine.cainz.com/wanqol/articles/fruit_01
   - りんごの安全性: https://inunavi.plan-b.co.jp/apple/
   - ほうれん草とシュウ酸: https://petokoto.com/articles/952
   - 生の大豆の危険性: https://petokoto.com/articles/1077
   - ナツメグの危険性: https://ikedaanihos.com/dog-cat-toxic-foods/

### ASPCA による有害食品リスト（要約）

- **アルコール・イースト生地**: 嘔吐、下痢、協調運動障害、中枢神経抑制、呼吸困難、昏睡、死亡の可能性
- **チョコレート・コーヒー・カフェイン**: メチルキサンチン含有、嘔吐、異常な心拍、痙攣、死亡の可能性
- **ぶどう・レーズン**: 腎臓障害、少量でも危険
- **玉ねぎ・にんにく・チャイブ**: 消化器刺激、赤血球損傷、貧血のリスク
- **マカダミアナッツ**: 脱力、嘔吐、高体温
- **キシリトール**: インスリン放出を促進、低血糖、肝障害

### 調査で判明した重要な知見

- **プルーン・すもも**: 果肉自体にソルビトールが多く、下痢を引き起こす。他の核果類と異なり果肉も危険
- **桃・さくらんぼ・りんご等**: 果肉は安全。種・茎・葉のみがアミグダリンを含み危険
- **いちじく**: フィシン（消化器刺激）とソラレン（光線過敏症）を含み、果肉も危険
- **スターフルーツ**: シュウ酸とカランボキシンを含み、腎臓に深刻な影響
- **アボカド**: 犬への毒性は明確なエビデンス不足。果肉は少量なら問題ない可能性
- **生の豚肉・鶏肉**: 細菌・寄生虫リスクがあるが、加熱すれば安全
- **生の牛肉**: 比較的安全だが、細菌リスクはある

---

## 技術仕様

- **使用モデル**: gpt-5-mini-2025-08-07（OpenAI via Vercel AI SDK）
- **バッチサイズ**: 20行
- **シャッフルシード**: 42（固定値、再現性確保）
- **出力形式**: CSV（食品番号, 理由, スコア）

## ファイル構造

```
process/03-1-dog-food-scoring/
├── index.ts                    # メイン処理スクリプト
├── readme.md                   # このファイル
└── result/                     # 出力ディレクトリ（自動生成）
    ├── scores.csv              # 評価結果（累積出力）
    └── progress.json           # 処理進捗（再開用）
```

## 後続プロセス（03-2）への連携

### 使用する出力ファイル

- **`result/scores.csv`**: 食品番号とスコアのマッピング
  - このファイルを読み込み、元のCSVデータと突き合わせてフィルタリングを行う
  - `食品番号`をキーとして結合する

### データ形式の注意点

- `scores.csv`の`食品番号`は元のCSVの2列目（食品番号）と一致する
- スコアが低い（1-4点）食品を除外する処理を想定
- `理由`列は参考情報として利用可能
